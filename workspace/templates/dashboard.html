{% extends "base_dashboard.html" %}
{% block title %}ProductForge AI Dashboard{% endblock %}
{% block content %}
    <div class="max-w-6xl mx-auto py-4 px-0">
        <header class="text-center mb-12">
            <h1 class="text-5xl font-bold text-indigo-400 mb-3">
                âš™ï¸ ProductForge AI Dashboard
            </h1>
            <p class="text-gray-400 text-lg">Multi-Agent AI System â€¢ Enterprise Architecture â€¢ v2.0</p>
        </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <!-- System Health Card -->
            <div class="bg-gray-800 rounded-xl p-6 border border-indigo-600">
                <h2 class="text-xl font-bold text-indigo-400 mb-4">ğŸ©º System Health</h2>
                <div id="healthStatus" class="text-sm space-y-2">
                    <p>Loading...</p>
                </div>
            </div>

            <!-- Agents Card -->
            <div class="bg-gray-800 rounded-xl p-6 border border-indigo-600">
                <h2 class="text-xl font-bold text-indigo-400 mb-4">ğŸ¤– Agents</h2>
                <div id="agentsList" class="text-sm space-y-2">
                    <p>Loading...</p>
                </div>
            </div>

            <!-- Results Card -->
            <div class="bg-gray-800 rounded-xl p-6 border border-indigo-600">
                <h2 class="text-xl font-bold text-indigo-400 mb-4">ğŸ“Š Recent Results</h2>
                <div id="resultsList" class="text-sm space-y-2">
                    <p>Loading...</p>
                </div>
            </div>

            <!-- Metrics Card -->
            <div class="bg-gray-800 rounded-xl p-6 border border-indigo-600">
                <h2 class="text-xl font-bold text-indigo-400 mb-4">ğŸ“ˆ Metrics</h2>
                <div id="metricsInfo" class="text-sm space-y-2">
                    <p>Uptime: <span id="uptime">--</span></p>
                    <p>Requests: <span id="totalRequests">--</span></p>
                    <p>Redis Latency: <span id="redisLatency">--</span> ms</p>
                    <p><a href="/metrics" class="text-indigo-400 hover:text-indigo-300 underline">View Prometheus Metrics â†’</a></p>
                </div>
            </div>

            <!-- Analytics & Trends Card -->
            <div class="bg-gray-800 rounded-xl p-6 border border-indigo-600 col-span-1 md:col-span-2 lg:col-span-2">
                <h2 class="text-xl font-bold text-indigo-400 mb-4 flex items-center gap-2">ğŸ“Š Analytics & Trends</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4" id="analyticsKPIs">
                    <div class="p-3 bg-gray-700 rounded">
                        <p class="text-xs text-gray-300">Tasks (7d)</p>
                        <p class="text-lg font-semibold" id="kpiTasks7d">--</p>
                    </div>
                </div>
                <!-- ...existing analytics/trends code... -->
            </div>

            <!-- Upload & Run Card -->
            <div class="rounded-2xl border border-indigo-500/30 p-4 shadow-md bg-gray-900">
              <h2 class="text-indigo-300 text-lg font-semibold mb-2">ğŸ“¤ Upload & Run</h2>
              <form id="uploadForm" enctype="multipart/form-data" class="space-y-2">
                <input type="file" name="file" required class="text-sm text-gray-300" />
                <button type="submit" class="px-3 py-1 bg-indigo-600 rounded-lg hover:bg-indigo-500">Upload</button>
              </form>
              <div id="uploadStatus" class="text-sm text-gray-400 mt-2"></div>
            </div>
                    </div>
                    <div class="p-3 bg-gray-700 rounded">
                        <p class="text-xs text-gray-300">Agents Active</p>
                        <p class="text-lg font-semibold" id="kpiAgents">--</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded">
                        <p class="text-xs text-gray-300">Avg Redis ms</p>
                        <p class="text-lg font-semibold" id="kpiRedisLatency">--</p>
                    </div>
                    <div class="p-3 bg-gray-700 rounded">
                        <p class="text-xs text-gray-300">Cache Hit %</p>
                        <p class="text-lg font-semibold" id="kpiCacheHit">--</p>
                    </div>
                </div>
                <canvas id="trendChart" height="90" class="mb-4"></canvas>
                <div class="flex justify-between items-center">
                    <a href="/analytics/trends" class="text-indigo-400 hover:text-indigo-300 text-sm underline">Full Trend JSON â†’</a>
                    <button id="generateReportBtn" class="bg-indigo-600 hover:bg-indigo-500 text-sm px-4 py-2 rounded">Generate Report</button>
                </div>
                <p id="reportStatus" class="text-xs text-gray-400 mt-2"></p>
            </div>
        </div>

        <div class="mt-8 text-center">
            <a href="/dashboard/help" class="text-indigo-400 hover:text-indigo-300">â“ Help & FAQ</a>
        </div>
    </div>

    {% block body_scripts %}
    <script>
        async function loadHealth() {
            const res = await fetch('/system/health');
            const data = await res.json();
            const redisIndicator = data.redis_connected ? '<span class="text-green-400">â—</span>' : '<span class="text-red-500">â—</span>';
            // OpenAI status from /system/status
            const statusRes = await fetch('/system/status');
            const statusData = await statusRes.json();
            const openaiIndicator = statusData.openai_key_active ? '<span class="text-green-400">â—</span>' : '<span class="text-yellow-400">â—</span>';
            document.getElementById('healthStatus').innerHTML = `
                <p>Status: <strong>${data.status}</strong></p>
                <p>Uptime: ${data.uptime_human}</p>
                <p>Redis: ${redisIndicator} ${data.redis_connected ? 'Connected' : 'Disconnected'}</p>
                <p>OpenAI Key: ${openaiIndicator} ${statusData.openai_key_active ? 'Active' : 'Missing'}</p>
                <p>Active Jobs: ${data.active_jobs}</p>
                <p>Version: v2.0.0</p>
            `;
            // update uptime in metrics card
            document.getElementById('uptime').textContent = data.uptime_human;
        }

        async function loadAgents() {
            const res = await fetch('/agents/');
            const data = await res.json();
            const html = data.slice(0, 5).map(a => 
                `<p>ğŸ¤– ${a.name} (${a.role}) - ${a.task_count} tasks</p>`
            ).join('');
            document.getElementById('agentsList').innerHTML = html || '<p>No agents</p>';
        }

        async function loadResults() {
            const res = await fetch('/results/?limit=5');
            const data = await res.json();
            const html = data.slice(0, 5).map(r => 
                `<p>ğŸ“‹ ${r.agent}: ${r.status}</p>`
            ).join('');
            document.getElementById('resultsList').innerHTML = html || '<p>No results</p>';
        }

        async function loadMetrics() {
            const res = await fetch('/metrics/json');
            const data = await res.json();
            document.getElementById('totalRequests').textContent = data.total_requests;
            document.getElementById('redisLatency').textContent = data.redis_latency_ms;
        }

        async function loadAnalytics() {
            const res = await fetch('/analytics/summary');
            const data = await res.json();
            document.getElementById('kpiTasks7d').textContent = data.window.d7.tasks;
            document.getElementById('kpiAgents').textContent = data.kpis.active_agents_count;
            document.getElementById('kpiRedisLatency').textContent = data.kpis.avg_redis_latency_ms;
            document.getElementById('kpiCacheHit').textContent = (data.kpis.cache_hit_ratio * 100).toFixed(1) + '%';
        }

        async function loadTrendChart() {
            const res = await fetch('/analytics/trends');
            const data = await res.json();
            const labels = data.series.map(p => p.t);
            const values = data.series.map(p => p.count);
            if (window.trendChartInstance) {
                window.trendChartInstance.data.labels = labels;
                window.trendChartInstance.data.datasets[0].data = values;
                window.trendChartInstance.update();
                return;
            }
            const ctx = document.getElementById('trendChart').getContext('2d');
            window.trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Tasks / Hour (24h)',
                        data: values,
                        borderColor: 'rgba(99,102,241,0.9)',
                        backgroundColor: 'rgba(99,102,241,0.2)',
                        tension: 0.25,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: {
                    plugins: {legend: {display: false}},
                    scales: {y: {beginAtZero: true, grid: {color: '#374151'}}, x: {grid: {display: false}}},
                }
            });
        }

        async function generateReport() {
            const btn = document.getElementById('generateReportBtn');
            const statusEl = document.getElementById('reportStatus');
            btn.disabled = true;
            statusEl.textContent = 'Generating report...';
            const res = await fetch('/reports/generate', {method: 'POST'});
            const data = await res.json();
            statusEl.textContent = 'Report created: ' + data.filename;
            btn.disabled = false;
        }

        document.getElementById('generateReportBtn').addEventListener('click', generateReport);

    loadHealth();
    loadAgents();
    loadResults();
    loadMetrics();
    loadAnalytics();
    loadTrendChart();

        setInterval(() => {
            loadHealth();
            loadAgents();
            loadResults();
            loadMetrics();
            loadAnalytics();
            loadTrendChart();
        }, 15000);
    </script>

<script>
const form = document.getElementById('uploadForm');
if (form) {
    form.addEventListener('submit', async e => {
        e.preventDefault();
        const data = new FormData(form);
        const res = await fetch('/upload/file', { method: 'POST', body: data });
        const json = await res.json();
        document.getElementById('uploadStatus').textContent =
            json.status === 'success'
                ? `âœ… Uploaded ${json.filename}`
                : `âŒ Upload failed: ${json.detail || 'Unknown error'}`;
    });
}
</script>
    {% endblock %}
{% endblock %}
